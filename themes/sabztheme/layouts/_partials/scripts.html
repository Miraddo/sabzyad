<script>
  // Consent helper (exposed early so other scripts can check before DOM ready)
  (function(){
    const CONSENT_KEY='cookieConsent:choice:v1';
    function choice(){ try { return JSON.parse(localStorage.getItem(CONSENT_KEY)||'').value || null; } catch(e){ return null; } }
    window.__optionalStorageAllowed = function(){ return choice()==='accept'; };
  })();

  // Mobile menu functionality & rest of site scripts
  document.addEventListener('DOMContentLoaded', function() {
    // Provide a tiny translation helper for JS strings
    try {
      window.__t = (key) => {
        const el = document.querySelector(`[data-i18n-key="${key}"]`);
        return el ? el.getAttribute('data-i18n-val') || el.textContent || '' : '';
      };
    } catch {}
    // First-visit language redirect (session-scoped), default to fa
    try {
      const seen = sessionStorage.getItem('langRedirected:v1');
      if(!seen){
        const pref = (navigator.language || navigator.userLanguage || '').toLowerCase();
        const wantFa = !pref || pref.startsWith('fa') || pref.startsWith('ar');
        const isFaPath = /\/(fa)(\/|$)/.test(location.pathname);
        const isEnPath = /\/(en)(\/|$)/.test(location.pathname);
        if(!isFaPath && !isEnPath){
          const target = wantFa ? '/fa/' : '/en/';
          sessionStorage.setItem('langRedirected:v1', '1');
          location.replace(target);
          return; // stop executing rest on this page
        }
        sessionStorage.setItem('langRedirected:v1', '1');
      }
    } catch(e) {}

    const optionalAllowed = window.__optionalStorageAllowed || (()=>false);

    const burger = document.querySelector('.navbar-burger');
    const menu = document.querySelector('.navbar-menu');

    if (burger && menu) {
      burger.addEventListener('click', function() {
        burger.classList.toggle('is-active');
        menu.classList.toggle('is-active');
  document.body.classList.toggle('no-scroll', menu.classList.contains('is-active'));
      });
    }

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Back to top button
    const backToTop = document.createElement('button');
    backToTop.innerHTML = '↑';
    backToTop.className = 'back-to-top';
  backToTop.setAttribute('aria-label', '{{ i18n "footer.back_to_top" }}');
    document.body.appendChild(backToTop);

    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 100) {
        backToTop.classList.add('show');
      } else {
        backToTop.classList.remove('show');
      }
    });

    // Theme handling
  const root = document.documentElement;
  const toggle = document.getElementById('themeToggle');
  const storedTheme = (optionalAllowed() ? localStorage.getItem('theme') : null);
    // Always set an explicit theme attribute (binary toggle) for predictable UX
    if (storedTheme === 'dark' || storedTheme === 'light') {
      root.setAttribute('data-theme', storedTheme);
    } else {
      const sys = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      root.setAttribute('data-theme', sys);
    }

    const updateToggleIcon = () => {
      if (!toggle) return;
      const isDark = root.getAttribute('data-theme') === 'dark';
  toggle.title = isDark ? '{{ i18n "theme.light" }}' : '{{ i18n "theme.dark" }}';
    };
    updateToggleIcon();

    toggle?.addEventListener('click', () => {
      const current = root.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      if(optionalAllowed()) {
        try { localStorage.setItem('theme', next); } catch(e){}
      }
      updateToggleIcon();
    });

    // Overlay Search (modal)
    const searchOverlay = document.createElement('div');
    searchOverlay.className = 'search-overlay';
    searchOverlay.innerHTML = `
      <div class="search-backdrop" data-search-close></div>
    <div class="search-panel" role="dialog" aria-modal="true" aria-label="{{ i18n "search.title" }}">
        <div class="search-header">
      <input id="siteSearchInput" type="search" placeholder="{{ i18n "search.placeholder" }}" aria-label="{{ i18n "search.title" }}" autocomplete="off" />
      <button class="search-close" data-search-close aria-label="{{ i18n "search.close" }}">×</button>
        </div>
        <div id="siteSearchResults" class="search-results"></div>
      </div>`;
    document.body.appendChild(searchOverlay);

    // Inject hidden i18n data elements for runtime JS to read
  (function injectI18nData(){
      const holder = document.createElement('div');
      holder.style.display = 'none';
      holder.innerHTML = `
    <span data-i18n-key="lessons.no_category" data-i18n-val="{{ i18n "lessons.no_category" }}"></span>
    <span data-i18n-key="lessons.error_loading_lesson" data-i18n-val="{{ i18n "lessons.error_loading_lesson" }}"></span>
    <span data-i18n-key="lessons.error_loading_content" data-i18n-val="{{ i18n "lessons.error_loading_content" }}"></span>
    <span data-i18n-key="lessons.placeholder.title" data-i18n-val="{{ i18n "lessons.placeholder.title" }}"></span>
    <span data-i18n-key="lessons.placeholder.lead" data-i18n-val="{{ i18n "lessons.placeholder.lead" }}"></span>
    <span data-i18n-key="lessons.placeholder.objectives" data-i18n-val="{{ i18n "lessons.placeholder.objectives" }}"></span>
    <span data-i18n-key="lessons.placeholder.obj1" data-i18n-val="{{ i18n "lessons.placeholder.obj1" }}"></span>
    <span data-i18n-key="lessons.placeholder.obj2" data-i18n-val="{{ i18n "lessons.placeholder.obj2" }}"></span>
    <span data-i18n-key="lessons.placeholder.obj3" data-i18n-val="{{ i18n "lessons.placeholder.obj3" }}"></span>
    <span data-i18n-key="lessons.placeholder.content" data-i18n-val="{{ i18n "lessons.placeholder.content" }}"></span>
    <span data-i18n-key="lessons.placeholder.content_desc" data-i18n-val="{{ i18n "lessons.placeholder.content_desc" }}"></span>
    <span data-i18n-key="lessons.placeholder.code_example" data-i18n-val="{{ i18n "lessons.placeholder.code_example" }}"></span>
    <span data-i18n-key="lessons.placeholder.hello_world" data-i18n-val="{{ i18n "lessons.placeholder.hello_world" }}"></span>
    <span data-i18n-key="lessons.placeholder.number" data-i18n-val="{{ i18n "lessons.placeholder.number" }}"></span>
    <span data-i18n-key="lessons.placeholder.practice" data-i18n-val="{{ i18n "lessons.placeholder.practice" }}"></span>
    <span data-i18n-key="lessons.placeholder.practice_desc" data-i18n-val="{{ i18n "lessons.placeholder.practice_desc" }}"></span>
    <span data-i18n-key="lessons.placeholder.resources" data-i18n-val="{{ i18n "lessons.placeholder.resources" }}"></span>
    <span data-i18n-key="lessons.placeholder.doc" data-i18n-val="{{ i18n "lessons.placeholder.doc" }}"></span>
    <span data-i18n-key="lessons.placeholder.video" data-i18n-val="{{ i18n "lessons.placeholder.video" }}"></span>
    <span data-i18n-key="lessons.placeholder.exercises" data-i18n-val="{{ i18n "lessons.placeholder.exercises" }}"></span>
    <span data-i18n-key="lessons.prev_lesson" data-i18n-val="{{ i18n "lessons.prev_lesson" }}"></span>
    <span data-i18n-key="lessons.next_lesson" data-i18n-val="{{ i18n "lessons.next_lesson" }}"></span>
    <span data-i18n-key="lessons.first_lesson" data-i18n-val="{{ i18n "lessons.first_lesson" }}"></span>
    <span data-i18n-key="lessons.last_lesson" data-i18n-val="{{ i18n "lessons.last_lesson" }}"></span>
    <span data-i18n-key="lessons.completed" data-i18n-val="{{ i18n "lessons.completed" }}"></span>
    <span data-i18n-key="lessons.open_list" data-i18n-val="{{ i18n "lessons.open_list" }}"></span>
    <span data-i18n-key="lessons.collapse_list" data-i18n-val="{{ i18n "lessons.collapse_list" }}"></span>
    <span data-i18n-key="lessons.focus_mode" data-i18n-val="{{ i18n "lessons.focus_mode" }}"></span>
    <span data-i18n-key="lessons.exit_focus_mode" data-i18n-val="{{ i18n "lessons.exit_focus_mode" }}"></span>
      `;
      document.body.appendChild(holder);
    })();

    const openBtns = document.querySelectorAll('[data-search-open]');
    const closeEls = searchOverlay.querySelectorAll('[data-search-close]');
  const inputEl = searchOverlay.querySelector('#siteSearchInput');
  const resultsEl = searchOverlay.querySelector('#siteSearchResults');
  const langPrefix = (document.documentElement.lang?.startsWith('fa') ? '/fa' : (document.documentElement.lang?.startsWith('en') ? '/en' : ''));
  const indexUrl = langPrefix + '/index.json';
    let searchIndex = [];

    function openSearch(){
      searchOverlay.classList.add('show');
      setTimeout(()=> inputEl?.focus(), 0);
    }
    function closeSearch(){
      searchOverlay.classList.remove('show');
      inputEl.value='';
      resultsEl.innerHTML='';
    }
    openBtns.forEach(b=> b.addEventListener('click', (e)=>{ e.preventDefault(); openSearch(); }));
    closeEls.forEach(el=> el.addEventListener('click', closeSearch));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSearch(); });

    const norm = s => (s||'').toString().toLowerCase();
    function render(items){
  if(!items.length){ resultsEl.innerHTML = '<p class="muted">{{ i18n "search.no_results" }}</p>'; return; }
      resultsEl.innerHTML = items.map(it => `
        <a class="search-row" href="${it.permalink}">
          <div class="row-title">${it.title}</div>
          <div class="row-desc">${it.description||''}</div>
          <div class="row-meta">${it.type==='posts'?'{{ i18n "types.post" }}':(it.type==='lessons'?'{{ i18n "types.lesson" }}':'{{ i18n "types.course" }}')}${it.date?` · ${it.date}`:''}</div>
        </a>`).join('');
    }
    function doSearch(q){
      const n = norm(q);
      if(!n){ render([]); return; }
      const res = searchIndex.filter(it => {
        const hay = [it.title, it.description, it.content, ...(it.tags||[]), ...(it.categories||[]), (it.course?.title||'')]
          .map(norm).join(' ');
        return hay.includes(n);
      }).slice(0, 25);
      render(res);
    }
    fetch(indexUrl).then(r=> r.ok ? r.json() : []).then(async d=>{
      searchIndex = Array.isArray(d)? d: [];
      if(searchIndex.length < 2){
        // Fallback: build a lightweight index from sitemap.xml (client-side crawl)
        try {
          const smUrl = langPrefix + '/sitemap.xml';
          const smResp = await fetch(smUrl);
          if(smResp.ok){
            const smText = await smResp.text();
            const urls = Array.from(smText.matchAll(/<loc>(.*?)<\/loc>/g)).map(m=> m[1])
              .filter(u=> (langPrefix ? u.includes(langPrefix + '/') : true) && !/\.xml$/.test(u) && !/\/tags\//.test(u) && !/\/categories\//.test(u));
            const limited = urls.slice(0, 60); // cap to avoid overload
            const fetched = await Promise.all(limited.map(async rawUrl=>{
              try {
                // Normalize to same-origin path to avoid CORS when running dev on a different port
                let localPath = rawUrl;
                try {
                  const parsed = new URL(rawUrl, window.location.origin);
                  // Always use just pathname (and search if present) so we stay same-origin
                  localPath = parsed.pathname + parsed.search;
                } catch { /* ignore parsing errors */ }
                const res = await fetch(localPath);
                if(!res.ok) return null;
                const html = await res.text();
                const title = (html.match(/<title>(.*?)<\/title>/i)||[])[1]||'';
                const desc = (html.match(/<meta[^>]+name=["']description["'][^>]*content=["']([^"']+)["']/i)||[])[1]||'';
                return { title, description: desc, permalink: localPath, content: '', date: '', type: /\/posts\//.test(localPath)?'posts':(/\/courses\//.test(localPath)?'courses':'other'), tags:[], categories:[], difficulty:null, course:null };
              } catch { return null; }
            }));
            const extra = fetched.filter(Boolean);
            if(extra.length) searchIndex = extra; // replace only if we built something
          }
        } catch {}
      }
    }).catch(()=>{});
    // debounce input
    let tId;
    inputEl?.addEventListener('input', (e)=> {
      const v = e.target.value;
      clearTimeout(tId);
      tId = setTimeout(()=> doSearch(v), 180);
    });
  });

  // Progress tracking for course pages
  // (function with Jalali conversion inserted AFTER definitions below)
  // Call progress tracking on page load after defining helper
  
  // Jalali (Shamsi) date conversion for Persian pages using date-fns-jalali library
  (function(){
    const lang = document.documentElement.lang || '';
    if(!lang.startsWith('fa')) return;
    const nodes = document.querySelectorAll('[data-date]');
    if(!nodes.length) return;
    
    // Load date-fns-jalali from CDN
    const script = document.createElement('script');
    script.type = 'module';
    script.innerHTML = `
      import { format } from 'https://cdn.jsdelivr.net/npm/date-fns-jalali@4.1.0-0/+esm';
      
      const pad = n => n < 10 ? ('0' + n) : n;
      const nodes = document.querySelectorAll('[data-date]');
      
      nodes.forEach(el => {
        const iso = el.getAttribute('data-date');
        if(!iso) return;
        
        try {
          const date = new Date(iso);
          // Format as Jalali date: yyyy/MM/dd
          const jalaliDate = format(date, 'yyyy/MM/dd');
          
          el.setAttribute('data-date-original', iso);
          el.textContent = jalaliDate;
        } catch(err) {
          console.error('Date conversion error:', err);
        }
      });
    `;
    document.body.appendChild(script);
  })();

  // Removed dangling trackCourseProgress call (function not defined)
</script>

<style>
  /* Theme toggle */
  .theme-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--bg-white);
    color: var(--text-medium);
    cursor: pointer;
    transition: var(--transition);
    margin-inline-end: .5rem;
  }
  .theme-toggle:hover {
    background: var(--bg-lighter);
  }

  .back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 3rem;
    height: 3rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .back-to-top.show {
    opacity: 1;
    visibility: visible;
  }

  .back-to-top:hover {
    background: var(--secondary-color);
    transform: translateY(-3px);
  }

  /* RTL adjustments for back to top button */
  .rtl .back-to-top {
    right: auto;
    left: 2rem;
  }

  /* Search overlay */
  .search-overlay{position:fixed;inset:0;display:none;z-index:1100}
  .search-overlay.show{display:block}
  .search-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
  .search-panel{position:absolute;top:8%;left:50%;transform:translateX(-50%);width:min(900px,92vw);max-height:84vh;display:flex;flex-direction:column;background:var(--bg-white);border:1px solid var(--border-color);border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  [data-theme="dark"] .search-panel{background:var(--bg-elevated)}
  .search-header{display:flex;gap:.5rem;padding:.75rem;border-bottom:1px solid var(--border-color)}
  .search-header input{flex:1;padding:.75rem 1rem;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-main)}
  .search-close{border:1px solid var(--border-color);background:var(--bg-white);color:var(--text-main);padding:0 .75rem;border-radius:10px}
  .search-results{overflow:auto;padding:.5rem 0}
  .search-row{display:block;padding:.75rem 1rem;border-bottom:1px solid var(--border-color);text-decoration:none;color:inherit}
  .search-row:hover{background:var(--bg-lighter)}
  .row-title{font-weight:600;margin-bottom:.25rem}
  .row-desc{color:var(--text-medium);font-size:.95rem}
  .row-meta{color:var(--text-dim);font-size:.85rem;margin-top:.25rem}
  /* Cookie consent banner */
  .cookie-consent{position:fixed;inset-inline:1rem;bottom:1rem;max-width:520px;margin-inline:auto;background:var(--bg-white);border:1px solid var(--border-color);border-radius:12px;box-shadow:0 10px 25px -5px rgba(0,0,0,.1),0 8px 16px -8px rgba(0,0,0,.06);padding:1rem 1.25rem;font-size:.9rem;line-height:1.5;z-index:1200;opacity:0;transform:translateY(15px);pointer-events:none;transition:.4s ease}
  .cookie-consent.show{opacity:1;transform:translateY(0);pointer-events:auto}
  .cookie-consent .cookie-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
  .cookie-consent .cc-btn{border:none;cursor:pointer;padding:.55rem 1rem;border-radius:8px;font-weight:600;font-size:.8rem}
  .cookie-consent .cc-btn.accept{background:var(--primary-color);color:#fff}
  .cookie-consent .cc-btn.accept:hover{background:var(--secondary-color)}
  .cookie-consent .cc-btn.decline{background:var(--bg-lighter);color:var(--text-dark)}
  [data-theme="dark"] .cookie-consent .cc-btn.decline{background:var(--bg-lighter);color:var(--text-light)}
  .cookie-consent .cc-btn.decline:hover{background:var(--border-color)}
  .cookie-consent .cc-link{display:inline-block;padding:.55rem .85rem;background:transparent;border:1px solid var(--border-color);border-radius:8px;font-size:.7rem;line-height:1;text-decoration:none;color:var(--text-medium)}
  .cookie-consent .cc-link:hover{background:var(--bg-lighter)}
  [data-theme="dark"] .cookie-consent{background:var(--bg-lighter)}
  [data-theme="dark"] .cookie-consent .cc-link{color:var(--text-light)}
  [data-theme="dark"] .cookie-consent .cc-link:hover{background:var(--border-color)}
  @media (max-width:600px){
    .cookie-consent{inset-inline:.75rem;bottom:.75rem;padding:.85rem .9rem}
    .cookie-consent .cookie-actions{flex-direction:column;align-items:stretch}
    .cookie-consent .cc-btn,.cookie-consent .cc-link{width:100%;text-align:center}
  }
</style>
