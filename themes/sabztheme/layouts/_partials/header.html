<header class="site-header">
  <nav class="navbar container" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
  <a class="navbar-item brand-logo" href="{{ "/" | relLangURL }}" aria-label="{{ .Site.Title }}">
        {{ $logo := .Site.Params.logo }}
        {{ $logoExists := and $logo (fileExists (printf "static%s" $logo)) }}
        {{ if $logoExists }}
          <img src="{{ $logo }}" alt="{{ .Site.Title }}" class="brand-image">
        {{ else }}
          {{ $emoji := or .Site.Params.logoEmoji "üå±" }}
          <div class="brand-content" data-placeholder-logo>
            <span class="brand-icon" aria-hidden="true">{{ $emoji }}</span>
            <span class="brand-text">{{ .Site.Title }}</span>
          </div>
        {{ end }}
      </a>
      
      <button role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasic">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </button>
    </div>

    <div id="navbarBasic" class="navbar-menu">
      <div class="navbar-start">
        {{ $current := . }}
        {{ range .Site.Menus.main }}
          {{/* Determine active: exact match OR (current path starts with menu URL and menu URL != '/') */}}
          {{ $u := .URL }}
          {{ $isExact := eq $u $current.RelPermalink }}
          {{ $isSection := and (ne $u "/") (hasPrefix $current.RelPermalink $u) }}
          {{ $active := or $isExact $isSection }}
          {{/* Build safe localized href: external URLs untouched, internal passed through relLangURL */}}
          {{ $raw := .URL }}
          {{ $isExternal := or (hasPrefix $raw "http://") (hasPrefix $raw "https://") (hasPrefix $raw "//") }}
          {{ $href := cond $isExternal $raw (relLangURL $raw) }}
          <a class="navbar-item{{ if $active }} is-active{{ end }}" href="{{ $href }}" aria-current="{{ if $active }}page{{ end }}">
            <span class="menu-text">{{ .Name }}</span>
          </a>
        {{ end }}
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <div class="navbar-actions">
            {{/* Language switcher (preserve current path when possible) */}}
            {{ $isFA := eq .Site.Language.Lang "fa" }}
            {{ $target := cond $isFA "en" "fa" }}
            {{ $translations := where .AllTranslations "Lang" $target }}
            {{ $tr := index $translations 0 }}
            {{ $hasCounterpart := gt (len $translations) 0 }}
            {{/* If translation exists, link to it; otherwise, try swapping the language prefix; finally fallback to target home */}}
            {{ $candidate := replaceRE "^/(fa|en)/" (printf "/%s/" $target) .RelPermalink }}
            {{ $fallback := printf "/%s/" $target }}
            {{ $switchURL := cond (not (eq $tr nil)) $tr.RelPermalink (cond (ne $candidate "") $candidate $fallback) }}
            {{ if $hasCounterpart }}
              {{ if $isFA }}
                <a class="action-btn" href="{{ $switchURL }}" aria-label="{{ i18n "header.switch_to_english" }}" title="English">EN</a>
              {{ else }}
                <a class="action-btn" href="{{ $switchURL }}" aria-label="{{ i18n "header.switch_to_persian" }}" title="{{ i18n "header.switch_to_persian" }}">ŸÅÿß</a>
              {{ end }}
            {{ end }}
            <button class="action-btn theme-toggle" id="themeToggle" aria-label="{{ i18n "header.change_theme" }}" title="{{ i18n "header.change_theme" }}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-moon">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
            <a class="action-btn search-btn" href="#" data-search-open aria-label="{{ i18n "header.search" }}" title="{{ i18n "header.search" }}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </a>
            <a class="btn btn-primary" href="{{ "/courses/" | relLangURL }}">
              <span>{{ i18n "header.start_learning" }}</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
